<ion-header class="ion-no-border">
  <ion-toolbar class="pt-4">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back" color="dark"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="fw-bold">Your Ticket</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="bg-light">

  @if (isLoading) {
    <div class="h-100 d-flex flex-column justify-content-center align-items-center">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="mt-3 text-muted fw-medium">Loading ticket...</p>
    </div>
  } 

  @else if (orderDetails) {
    <div class="content-wrapper px-3 pb-5">
      
      <div class="text-center py-3 animate__animated animate__fadeInDown">
       @if(orderDetails.status !== 'Confirmed') {
         <div class="success-icon-bg mx-auto">
          <ion-icon name="close-circle" color="danger" style="font-size: 48px;"></ion-icon>
        </div>
        <h2 class="fw-bold mt-2 mb-0">Booking Cancelled!</h2>
       } @else {
         <div class="success-icon-bg mx-auto">
          <ion-icon name="checkmark-circle" color="success" style="font-size: 48px;"></ion-icon>
        </div>
        <h2 class="fw-bold mt-2 mb-0">Booking Confirmed!</h2>
       }
        <p class="text-muted small">Order ID: #{{orderDetails.orderId}}</p>
      </div>

      <div id="ticket-container" class="animate__animated animate__fadeInUp">
        
        <div class="ticket-main">
          <div class="event-banner" 
               [style.backgroundImage]="'url(' + (orderDetails.event?.imageUrl || 'https://dummyimage.com/1080x1410/e0e0e0/c2c2c2.png&text=Event') + ')'">
            <div class="overlay"></div>
            <div class="event-title-overlay">
              <span class="badge-category">{{orderDetails.event?.category || 'Event'}}</span>
              <h1>{{orderDetails.event?.title || orderDetails.title}}</h1>
            </div>
          </div>

          <div class="p-3">
            <ion-grid class="p-0 mb-3">
              <ion-row>
                <ion-col size="6" class="border-end">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <ion-icon name="calendar-outline" color="primary"></ion-icon>
                    <small class="text-muted fw-bold">DATE</small>
                  </div>
                  <div class="fw-bold text-dark">{{orderDetails.event?.date | date:'mediumDate'}}</div>
                </ion-col>
                <ion-col size="6" class="ps-3">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <ion-icon name="time-outline" color="primary"></ion-icon>
                    <small class="text-muted fw-bold">TIME</small>
                  </div>
                  <div class="fw-bold text-dark">{{orderDetails.event?.time || 'TBA'}}</div>
                </ion-col>
              </ion-row>
            </ion-grid>

            <div class="location-box p-2 rounded bg-light mb-3" (click)="openInGoogleMaps()">
              <div class="d-flex align-items-start gap-2">
                <ion-icon name="location-outline" color="danger" class="mt-1"></ion-icon>
                <div>
                  <small class="text-muted fw-bold d-block">LOCATION</small>
                  <span class="fw-semibold text-dark">{{orderDetails.event?.location || 'View on Map'}}</span>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
               <div>
                 <small class="text-muted">Guest</small>
                 <div class="fw-bold">{{orderDetails.customerName}}</div>
               </div>
               <div class="text-end">
                 <small class="text-muted">Tickets</small>
                 <div class="fw-bold">{{orderDetails.ticketCount}} Person(s)</div>
               </div>
             </div>
          </div>
        </div>

        <div class="ticket-rip">
          <div class="circle-left"></div>
          <div class="dashed-line"></div>
          <div class="circle-right"></div>
        </div>

        <div class="ticket-stub text-center p-3">
          <div class="qr-box mx-auto mb-2">
            <img [src]="qrUrl" alt="Ticket QR" class="img-fluid">
          </div>
          <small class="text-muted d-block" style="font-size: 10px; letter-spacing: 1px;">SCAN AT ENTRY</small>
          <div class="mt-2 text-dark fw-bold monospace">
            {{orderDetails.orderId}}
          </div>
        </div>
      </div> 

      <div class="mt-4 rounded-3 bg-light border d-flex justify-content-center align-items-center" style="height: 100px;">
        <div id="ad-container" style="text-align: center;"></div>
      </div>

    </div>
  }

  @else {
    <div class="h-100 d-flex flex-column justify-content-center align-items-center px-4">
      <ion-icon name="alert-circle-outline" color="medium" style="font-size: 64px;"></ion-icon>
      <h3 class="mt-2 text-dark">Ticket Not Found</h3>
      <p class="text-muted text-center">We couldn't load the ticket details. Please try again.</p>
      <ion-button (click)="goBack()" color="dark" shape="round" class="mt-3">Go Back</ion-button>
    </div>
  }

  <ion-toast [isOpen]="isToastOpen" [message]="toastMessage" [duration]="2000" (didDismiss)="isToastOpen = false"></ion-toast>

</ion-content>

<ion-footer class="ion-no-border" *ngIf="!isLoading && orderDetails">
  <div class="bg-white border-top p-3 d-flex justify-content-around pb-4">
    <div class="action-btn text-center" (click)="downloadTicket()">
      <div class="icon-circle bg-light mb-1">
        <ion-icon name="download-outline" color="dark"></ion-icon>
      </div>
      <small>Save</small>
    </div>
    <div class="action-btn text-center" (click)="shareTicket()">
      <div class="icon-circle bg-primary-subtle mb-1">
        <ion-icon name="share-social-outline" color="primary"></ion-icon>
      </div>
      <small>Share</small>
    </div>
    <div class="action-btn text-center" (click)="openInGoogleMaps()">
      <div class="icon-circle bg-danger-subtle mb-1">
        <ion-icon name="map-outline" color="danger"></ion-icon>
      </div>
      <small>Map</small>
    </div>
  </div>
</ion-footer>